{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dashboard | VMS</title>

<style>
:root{
  --glass-bg: rgba(255,255,255,.72);
  --glass-shadow: 0 18px 40px rgba(0,0,0,.18);
  --primary:#0b5cff;
}

/* ===== BASE ===== */
*{box-sizing:border-box}
html,body{height:100%;margin:0}

body{
  font-family:"Segoe UI",Tahoma,Verdana,sans-serif;
  background-image:url("https://i.pinimg.com/736x/f8/ad/d5/f8add51acaad02b06db9c2c8b1483898.jpg");
  background-size:cover;
  background-position:center;
  color:#111;
}

.layout{display:flex;height:100vh;padding:24px;gap:20px}

/* ===== SIDEBAR ===== */
.sidebar{
  width:260px;
  background:var(--glass-bg);
  backdrop-filter:blur(14px);
  box-shadow:var(--glass-shadow);
  border-radius:20px;
  padding:24px 18px;
}

.sidebar h2{text-align:center;margin-bottom:22px}

.nav a{
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 16px;
  border-radius:12px;
  margin-bottom:8px;
  font-weight:600;
  text-decoration:none;
  color:#111;
}

.nav a:hover,.nav a.active{
  background:rgba(0,0,0,.85);
  color:#fff;
}

/* ===== MAIN ===== */
.main{flex:1;display:flex;flex-direction:column;gap:20px}

/* ===== TOPBAR ===== */
.topbar{
  background:var(--glass-bg);
  backdrop-filter:blur(14px);
  box-shadow:var(--glass-shadow);
  border-radius:18px;
  padding:16px 22px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:relative;
  z-index:1000;
}

/* ===== PROFILE ===== */
.profile{position:relative}

.profile-btn{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 14px;
  border-radius:999px;
  background:rgba(255,255,255,.55);
  border:1px solid rgba(0,0,0,.15);
  font-weight:700;
  cursor:pointer;
}

.profile-menu{
  position:absolute;
  right:0;
  top:54px;
  width:260px;
  background:var(--glass-bg);
  backdrop-filter:blur(14px);
  box-shadow:var(--glass-shadow);
  border-radius:16px;
  padding:14px;
  display:none;
  z-index:9999;
}

.profile-menu.show{display:block}

.logout-btn{
  width:100%;
  border:none;
  background:#e53935;
  color:#fff;
  padding:10px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}

/* ===== CONTENT ===== */
.content{
  flex:1;
  background:var(--glass-bg);
  backdrop-filter:blur(14px);
  box-shadow:var(--glass-shadow);
  border-radius:22px;
  padding:28px;
  overflow:auto;
}

/* ===== STATS ===== */
.stats-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:22px;
}

.stat-box{
  background:rgba(255,255,255,.65);
  border-radius:22px;
  padding:24px;
  box-shadow:0 18px 35px rgba(0,0,0,.18);
  text-align:center;
}

.circle{
  width:120px;
  height:120px;
  border-radius:50%;
  margin:14px auto;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  background:#fff;
  animation: beat var(--beat-speed) infinite ease-in-out;
}

.circle span{
  font-size:22px;
  font-weight:800;
}

@keyframes beat{
  0%{transform:scale(1)}
  30%{transform:scale(1.08)}
  60%{transform:scale(.96)}
  100%{transform:scale(1)}
}

/* mini panels */
.panel-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:18px;
  margin-top:18px;
}

.panel{
  background:rgba(255,255,255,.9);
  padding:16px;
  border-radius:12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  text-align:left;
}

.small{
  font-size:13px;color:#555;margin-top:8px;
}

.chart-wrap{max-width:900px;margin:18px auto}
</style>
</head>

<body>
<div class="layout">

<!-- SIDEBAR -->
<aside class="sidebar">
  <h2>VMS panelüêæ</h2>
  <nav class="nav">
    <a class="active" href="/">Dashboard</a>
    <a href="/patients/">Patients</a>
    <a href="/appointments/">Appointments</a>
    <a href="/receipts/">Receipts</a>
    <a href="/overview/">Overview</a>
  </nav>
</aside>

<!-- MAIN -->
<main class="main">

<div class="topbar">
  <h1>
    {% if dashboard_for == 'doctor' %}
      Veterinary Management System üêæ
    {% else %}
      Client Dashboard ‚Äî VMS 
    {% endif %}
  </h1>

  <div class="profile">
    <div class="profile-btn" id="profileBtn">
      {% if dashboard_for == 'doctor' %}
        {{ request.user.get_full_name|default:request.user.username }} ‚ñº
      {% else %}
        {{ client.full_name|default:client.username }} ‚ñº
      {% endif %}
    </div>

    <div class="profile-menu" id="profileMenu">
      {% if dashboard_for == 'doctor' %}
        <p><strong>{{ request.user.get_full_name|default:request.user.username }}</strong></p>
        <p>Email: {{ request.user.email }}</p>
        <form method="post" action="{% url 'logout' %}">{% csrf_token %}<button class="logout-btn">Logout</button></form>
      {% else %}
        <p><strong>{{ client.full_name }}</strong></p>
        <p>Email: {{ client.email }}</p>
        <form method="post" action="{% url 'logout' %}">{% csrf_token %}<button class="logout-btn">Logout</button></form>
      {% endif %}
    </div>
  </div>
</div>

<section class="content">

  <div class="stats-grid">
    <div class="stat-box" data-value="{{ patients_count }}" data-max="500">
      <div>üê∂ Patients</div>
      <div class="circle"><span>0</span></div>
      <div class="small">Total patients in your account</div>
    </div>

    <div class="stat-box" data-value="{{ appointments_count }}" data-max="500">
      <div>üìÖ Appointments</div>
      <div class="circle"><span>0</span></div>
      <div class="small">All scheduled appointments (past + future)</div>
    </div>

    <div class="stat-box" data-value="{{ receipts_count }}" data-max="500">
      <div>üßæ Receipts</div>
      <div class="circle"><span>0</span></div>
      <div class="small">Receipts count ‚Äî Paid: {{ receipts_paid_count }}, Total:&nbsp;{{ receipts_total }}</div>
    </div>
  </div>

  <div class="panel-grid">
    <div class="panel">
      <h3>Quick summary</h3>
      <p class="small">
        {% if dashboard_for == 'doctor' %}
          Global counts shown. Use the left menu to manage records.
        {% else %}
          Showing data for: <strong>{{ client.full_name }}</strong> ({{ client.client_id }})
        {% endif %}
      </p>

      <ul class="small">
        <li>Patients: {{ patients_count }}</li>
        <li>Appointments: {{ appointments_count }}</li>
        <li>Receipts: {{ receipts_count }} (Paid: {{ receipts_paid_count }})</li>
        <li>Total received amount: {{ receipts_total }}</li>
      </ul>
    </div>

    <div class="panel">
      <h3>Monthly visits</h3>
      <div class="small">Visits per month (by visit_date)</div>
      <div class="chart-wrap">
        <canvas id="visitsChart" width="600" height="220"></canvas>
      </div>
    </div>
  </div>

</section>
</main>
</div>

<!-- SCRIPTS -->
<script>
/* PROFILE DROPDOWN */
const btn=document.getElementById("profileBtn");
const menu=document.getElementById("profileMenu");
if(btn){
  btn.onclick=e=>{e.stopPropagation();menu.classList.toggle("show")};
  document.onclick=()=>menu.classList.remove("show");
}

/* HEART COUNTERS */
document.querySelectorAll(".stat-box").forEach(box=>{
  const val = parseInt(box.dataset.value || 0);
  const max = parseInt(box.dataset.max || 100);
  const bpm = Math.min(160, Math.max(50, (val/max)*120 || 70));
  box.style.setProperty("--beat-speed", (60/bpm) + "s");

  const span = box.querySelector("span");
  let c = 0;
  const step = Math.max(1, Math.floor(Math.max(val/25, 1)));
  const t = setInterval(()=>{
    c += step;
    if(c >= val){ c = val; clearInterval(t); }
    span.textContent = c;
  }, 40);
});

/* Chart - monthly visits */
const labels = {{ chart_labels_json|safe }};
const data = {{ chart_data_json|safe }};

(function(){
  // load Chart.js from CDN if not present
  function initChart(){
    const ctx = document.getElementById('visitsChart').getContext('2d');
    // eslint-disable-next-line no-undef
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Visits',
          data: data,
          fill: true,
          tension: 0.3,
          borderWidth: 2,
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: { beginAtZero: true, ticks: { precision:0 } }
        }
      }
    });
  }

  if (typeof Chart === 'undefined') {
    const s = document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/chart.js";
    s.onload = initChart;
    document.head.appendChild(s);
  } else {
    initChart();
  }
})();
</script>

</body>
</html>
